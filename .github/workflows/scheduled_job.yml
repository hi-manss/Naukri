name: Scheduled Naukri Job

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'   # daily at 06:00 UTC â€” adjust if needed

jobs:
  run-naukri:
    runs-on: ubuntu-latest

    env:
      # provide these via Repository -> Settings -> Secrets -> Actions
      NAUKRI_USERNAME: ${{ secrets.NAUKRI_USERNAME }}
      NAUKRI_PASSWORD: ${{ secrets.NAUKRI_PASSWORD }}
      NAUKRI_MOBILE:   ${{ secrets.NAUKRI_MOBILE }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Chromium & chromedriver (apt)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            chromium-browser \
            chromium-chromedriver \
            ca-certificates \
            fonts-liberation \
            libasound2 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdbus-1-3 \
            libgconf-2-4 \
            libgbm1 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libx11-xcb1 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            xdg-utils \
            wget \
            unzip

          chromium-browser --version || true
          chromedriver --version || true

      - name: Export Chrome env variables
        run: |
          echo "CHROME_BIN=/usr/bin/chromium-browser" >> $GITHUB_ENV
          echo "CHROMEDRIVER=/usr/bin/chromedriver" >> $GITHUB_ENV

      - name: Debug workspace (optional)
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          pwd
          ls -la

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # ensure webdriver-manager is available
          pip install webdriver-manager

      - name: (optional) Inject secrets into constants.py (only if constants.py exists)
        env:
          NAUKRI_USERNAME: ${{ secrets.NAUKRI_USERNAME }}
          NAUKRI_PASSWORD: ${{ secrets.NAUKRI_PASSWORD }}
          NAUKRI_MOBILE: ${{ secrets.NAUKRI_MOBILE }}
        run: |
          # Do not echo secrets. Only update constants.py if present and secrets are set.
          if [ -z "$NAUKRI_USERNAME" ] || [ -z "$NAUKRI_PASSWORD" ]; then
            echo "Secrets not provided; skipping constants.py update."
          elif [ -f constants.py ]; then
            cp constants.py constants.py.bak || true
            perl -0777 -pe "s/USERNAME\s*=\s*['\"].*?['\"]/USERNAME = \"$NAUKRI_USERNAME\"/s;
                            s/PASSWORD\s*=\s*['\"].*?['\"]/PASSWORD = \"$NAUKRI_PASSWORD\"/s;
                            s/MOBILE\s*=\s*['\"].*?['\"]/MOBILE = \"$NAUKRI_MOBILE\"/s" -i constants.py
            echo "constants.py updated (backup saved)."
          else
            echo "constants.py not found; skipping update."
          fi

      - name: Run unit tests
        run: |
          python -m unittest discover -v || python -m unittest -v

      - name: Run Naukri script (only on manual dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "Running Naukri script (manual run)..."
          python naukri.py
